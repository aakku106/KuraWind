import{j as e,r as i,a as x}from"./index-CF7Ri3zE.js";import{g as j,a as p,b as v,d as N}from"./messages-CqlhHQyZ.js";import{AiOutlineArrowLeft as y}from"./index-DiO1dPfR.js";import"./iconBase-CxOQWq9U.js";function b({friendName:s,friendAvatar:a,friendOnline:n,onBack:t,onClearHistory:l}){return e.jsxs("div",{className:"chat-header",children:[e.jsx("button",{className:"back-btn",onClick:t,children:e.jsx(y,{size:24})}),e.jsxs("div",{className:"chat-header-info",children:[e.jsxs("div",{className:"avatar-container",children:[e.jsx("div",{className:"avatar small",children:a}),n&&e.jsx("div",{className:"online-indicator small"})]}),e.jsxs("div",{className:"friend-details",children:[e.jsx("span",{className:"friend-name",children:s}),e.jsx("span",{className:`status ${n?"online":"offline"}`,children:n?"Online":"Offline"})]})]}),e.jsx("div",{className:"chat-actions",children:e.jsx("button",{onClick:l,className:"action-btn clear-history",title:"Clear Chat History",children:"🗑️"})})]})}function w({message:s,isOwn:a}){const n=c=>{if(!c)return"";if(typeof c=="string")return c;try{return new Date(c).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch{return""}},t=typeof s=="string"?s:s.message||s.content||"",l=typeof s=="string"?"":s.timestamp;return e.jsx("div",{className:`message-wrapper ${a?"own":"other"}`,children:e.jsxs("div",{className:`message-bubble ${a?"own":"other"}`,children:[e.jsx("div",{className:"message-content",children:t}),e.jsxs("div",{className:"message-time",children:[n(l),a&&e.jsx("span",{className:"message-status",children:s.status==="sent"?"✓":"✓✓"})]})]})})}function M({chatId:s,currentUser:a,refreshTrigger:n}){const[t,l]=i.useState([]),[c,o]=i.useState(!0),[d,h]=i.useState(!1),u=i.useRef(null),m=i.useRef(null);return i.useEffect(()=>{(async()=>{d||(o(!0),await new Promise(g=>setTimeout(g,300)));const f=j(s);l(f),d||(o(!1),h(!0))})()},[s,d]),i.useEffect(()=>{if(d&&n!==void 0){const r=j(s);l(r)}},[n,s,d]),i.useEffect(()=>{if(!c&&t.length>0){m.current&&m.current.scrollIntoView({behavior:"smooth"});const r=setTimeout(()=>{m.current&&m.current.scrollIntoView({behavior:"smooth"}),u.current&&(u.current.scrollTop=u.current.scrollHeight)},100);return()=>clearTimeout(r)}},[t.length,c]),c?e.jsx("div",{className:"messages-container",ref:u,children:e.jsx("div",{className:"messages-list",children:e.jsx("div",{style:{display:"flex",justifyContent:"center",padding:"1rem",color:"var(--text-secondary, rgba(44, 62, 80, 0.6))"},children:e.jsxs("div",{className:"loading-dots",children:[e.jsx("span",{children:"•"}),e.jsx("span",{children:"•"}),e.jsx("span",{children:"•"})]})})})}):e.jsx("div",{className:"messages-container",ref:u,children:e.jsxs("div",{className:"messages-list",children:[t.length===0?e.jsx("div",{className:"no-messages",children:e.jsx("p",{children:"No messages yet. Start the conversation! 👋"})}):t.map(r=>e.jsx(w,{message:r,isOwn:r.senderId===a?.id},r.id)),e.jsx("div",{ref:m})]})})}function C({chatId:s,currentUser:a,onMessageSent:n}){const[t,l]=i.useState(""),c=async o=>{o.preventDefault(),t.trim()&&await p(s,{message:t.trim(),senderId:a?.id||"current-user",senderName:a?.userName||"You"})&&(l(""),n&&n())};return e.jsx("div",{className:"message-input-container",children:e.jsxs("form",{className:"message-form",onSubmit:c,children:[e.jsxs("div",{className:"input-wrapper",children:[e.jsx("button",{type:"button",className:"attachment-btn",children:"📎"}),e.jsx("input",{type:"text",className:"message-input",placeholder:"Type a message...",value:t,onChange:o=>l(o.target.value)}),e.jsx("button",{type:"button",className:"emoji-btn",children:"🦊"})]}),e.jsx("button",{type:"submit",className:`send-btn ${t.trim()?"active":""}`,disabled:!t.trim(),children:"➤"})]})})}function E({chatId:s,friendName:a,friendAvatar:n,friendOnline:t,onBack:l}){const[c,o]=i.useState(0),d=i.useRef(null),h=i.useMemo(()=>JSON.parse(localStorage.getItem("kurawind-user"))||{id:"current-user",userName:"You"},[]);i.useEffect(()=>{x.init(h);const r=f=>{v(s,f),o(g=>g+1)};return x.subscribeToChat(s,s,r),()=>{x.unsubscribe()}},[s,h]);const u=()=>{window.confirm(`Are you sure you want to clear all chat history with ${a}? This action cannot be undone.`)&&(N(s,a)?(o(f=>f+1),alert("Chat history cleared successfully!")):alert("Failed to clear chat history. Please try again."))},m=()=>{o(r=>r+1)};return e.jsxs("div",{className:"chat-container",children:[e.jsx(b,{friendName:a,friendAvatar:n,friendOnline:t,onBack:l,onClearHistory:u}),e.jsx(M,{chatId:s,currentUser:h,refreshTrigger:c,ref:d}),e.jsx(C,{chatId:s,currentUser:h,onMessageSent:m})]})}export{E as default};
